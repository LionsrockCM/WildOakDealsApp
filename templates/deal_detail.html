<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Deal Details</title>
    <!-- Add any additional CSS or meta tags here if needed -->
</head>
<body>
    <!-- User greeting and navigation links -->
    <p>Welcome, {{ current_user.username }}!</p>
    <a href="{{ url_for('home') }}">Back to Home</a>
    <a href="{{ url_for('logout') }}">Logout</a>

    <!-- Deal details section -->
    <h1>Deal Details</h1>
    {% if deal %}
        <div>
            <h2>{{ deal.deal_name }}</h2>
            <p>State: {{ deal.state }}</p>
            <p>City: {{ deal.city }}</p>
            <p>Status: {{ deal.status }}</p>
            <p>Created At: {{ deal.created_at }}</p>
            <p>Updated At: {{ deal.updated_at }}</p>
            <!-- Add more deal attributes here if your Deal model has additional fields -->
        </div>
    {% else %}
        <p>No deal found.</p>
    {% endif %}

    <!-- Associated files section -->
    <h2>Associated Files</h2>
    {% if files %}
        <ul id="fileList">
        {% for file in files %}
            <li>{{ file.file_name }} - <a href="{{ file.dropbox_link }}" target="_blank">View on Dropbox</a> 
                <a href="#" onclick="deleteFile({{ file.id }}, event); return false;">Delete</a></li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No files associated with this deal.</p>
    {% endif %}

    <!-- File upload form -->
    <h2>Upload New File</h2>
    <div id="fileSuccessMessage" style="display: none; color: green; margin-bottom: 10px;">File uploaded successfully!</div>
    <form id="fileForm" action="{{ url_for('files', deal_id=deal.id) }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
            <label for="file_name">File Name:</label>
            <input type="text" id="file_name" name="file_name" required>
            <span class="error-message" id="file_name_error"></span>
        </div>
        <div>
            <label for="dropbox_link">Dropbox Link:</label>
            <input type="text" id="dropbox_link" name="dropbox_link" required>
            <span class="error-message" id="dropbox_link_error"></span>
        </div>
        <button type="submit">Upload File</button>
    </form>

    <!-- JavaScript for file management -->
    <script>
        // Function to delete a file
        function deleteFile(fileId, event) {
            event.preventDefault();
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            if (!csrfToken) {
                console.error('CSRF token not found');
                alert('CSRF token not found');
                return;
            }
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`/api/files/${fileId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    console.log('Delete file response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to delete file');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Delete file data:', data);
                    alert(data.message);
                    fetchFiles(); // Refresh the file list
                })
                .catch(error => {
                    console.error('Error deleting file:', error);
                    alert('Error deleting file: ' + error.message);
                });
            }
        }

        // Function to fetch and update the file list
        function fetchFiles() {
            const dealId = {{ deal.id }};
            fetch(`/api/files/${dealId}`, {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                console.log('Fetch files response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Failed to fetch files: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Files data received:', data);
                const fileList = document.getElementById('fileList');
                if (fileList) {
                    fileList.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(file => {
                            const li = document.createElement('li');
                            li.innerHTML = `${file.file_name} - <a href="${file.dropbox_link}" target="_blank">View on Dropbox</a> 
                                <a href="#" onclick="deleteFile(${file.id}, event); return false;">Delete</a>`;
                            fileList.appendChild(li);
                        });
                    } else {
                        fileList.innerHTML = '<p>No files associated with this deal.</p>';
                    }
                }
            })
            .catch(error => console.error('Error fetching files:', error));
        }

        // Event listeners for form handling
        document.addEventListener('DOMContentLoaded', function() {
            const fileForm = document.getElementById('fileForm');
            const fileInputs = fileForm.querySelectorAll('input[required]');
            const fileSuccessMessage = document.getElementById('fileSuccessMessage');

            // Validate inputs on blur and clear errors on input
            fileInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.tagName === 'INPUT' && this.hasAttribute('required')) validateField(this);
                });
                input.addEventListener('input', function() {
                    if (this.value.trim() !== '' && this.tagName === 'INPUT' && this.hasAttribute('required')) {
                        document.getElementById(`${this.id}_error`).textContent = '';
                    }
                });
            });

            // Handle form submission
            fileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                let isValid = true;
                fileInputs.forEach(input => {
                    if (!validateField(input)) isValid = false;
                });
                if (isValid) {
                    const formData = new FormData(fileForm);
                    fetch(fileForm.action, {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    })
                    .then(response => {
                        console.log('File submission response:', response.status);
                        if (!response.ok) {
                            return response.json().then(error => { throw new Error(error.error || 'Bad request'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('File submission data:', data);
                        if (data.message) {
                            fileSuccessMessage.textContent = data.message;
                            fileSuccessMessage.style.display = 'block';
                            fileSuccessMessage.style.color = 'green';
                            fileForm.reset();
                            setTimeout(() => fileSuccessMessage.style.display = 'none', 3000);
                            fetchFiles(); // Refresh file list
                        } else if (data.error) {
                            fileSuccessMessage.textContent = data.error;
                            fileSuccessMessage.style.color = 'red';
                            fileSuccessMessage.style.display = 'block';
                            setTimeout(() => fileSuccessMessage.style.display = 'none', 3000);
                        }
                    })
                    .catch(error => {
                        console.error('File submission error:', error);
                        fileSuccessMessage.textContent = error.message || 'An error occurred';
                        fileSuccessMessage.style.color = 'red';
                        fileSuccessMessage.style.display = 'block';
                        setTimeout(() => fileSuccessMessage.style.display = 'none', 3000);
                    });
                }
            });

            // Validation function for form fields
            function validateField(field) {
                console.log('validateField called for field:', field ? field.id : 'undefined');
                if (!field) {
                    console.error('Field is undefined');
                    return true;
                }
                if (field.tagName === 'INPUT' && field.hasAttribute('required')) {
                    const errorElement = document.getElementById(`${field.id}_error`);
                    if (!errorElement) {
                        console.error(`Error element not found for field: ${field.id}`);
                        return true;
                    }
                    if (!field.value || !field.value.trim()) {
                        errorElement.textContent = 'Field required';
                        errorElement.style.color = 'red';
                        return false;
                    }
                    errorElement.textContent = '';
                    return true;
                }
                return true;
            }

            // Fetch files when the page loads
            fetchFiles();
        });
    </script>
</body>
</html>