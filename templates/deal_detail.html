<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Deal Details - Wild Oak Deals</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="navbar">
        <a href="/" class="navbar-brand">Wild Oak Deals</a>
        <div class="navbar-nav">
            <a href="{{ url_for('home') }}" class="nav-link">Home</a>
            <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="row mt-3">
            <div class="welcome-message">Welcome, {{ current_user.username }}!</div>

            <!-- Deal details section -->
            {% if deal %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h2>{{ deal.deal_name }}</h2>
                    </div>
                    <div class="card-body">
                        <div class="deal-info">
                            <div class="info-item">
                                <span class="info-label">State:</span>
                                <span class="info-value">{{ deal.state }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">City:</span>
                                <span class="info-value">{{ deal.city }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status:</span>
                                <span class="info-value status-badge">{{ deal.status }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Created:</span>
                                <span class="info-value">{{ deal.created_at }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Updated:</span>
                                <span class="info-value">{{ deal.updated_at }}</span>
                            </div>
                        </div>

                        <div class="action-buttons mt-3">
                            <button class="btn btn-primary" onclick="showEditForm()">Edit Deal</button>
                            <button class="btn btn-danger" onclick="deleteDeal({{ deal.id }})">Delete Deal</button>
                        </div>
                    </div>
                </div>

                <!-- Edit form (initially hidden) -->
                <div id="editForm" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3>Edit Deal</h3>
                        </div>
                        <div class="card-body">
                            <div id="editSuccessMessage" style="display: none;" class="alert alert-success mb-3">Deal updated successfully!</div>
                            <form id="editDealForm" action="{{ url_for('deal_modify', deal_id=deal.id) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="form-group">
                                    <label for="edit_deal_name" class="form-label">Deal Name</label>
                                    <input type="text" id="edit_deal_name" name="deal_name" value="{{ deal.deal_name }}" class="form-control" required>
                                    <span class="error-message" id="edit_deal_name_error"></span>
                                </div>
                                <div class="form-group">
                                    <label for="edit_state" class="form-label">State</label>
                                    <input type="text" id="edit_state" name="state" value="{{ deal.state }}" class="form-control" required>
                                    <span class="error-message" id="edit_state_error"></span>
                                </div>
                                <div class="form-group">
                                    <label for="edit_city" class="form-label">City</label>
                                    <input type="text" id="edit_city" name="city" value="{{ deal.city }}" class="form-control" required>
                                    <span class="error-message" id="edit_city_error"></span>
                                </div>
                                <div class="form-group">
                                    <label for="edit_status" class="form-label">Status</label>
                                    <input type="text" id="edit_status" name="status" value="{{ deal.status }}" class="form-control" required>
                                    <span class="error-message" id="edit_status_error"></span>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary">Update Deal</button>
                                    <button type="button" class="btn btn-secondary" onclick="hideEditForm()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Status History Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>Status History</h3>
                    </div>
                    <div class="card-body">
                        {% if status_history %}
                            <ul class="history-list">
                            {% for history in status_history %}
                                <li class="history-item">
                                    <span class="status-badge">{{ history.status }}</span> changed by 
                                    <span class="user-badge">{{ history.user.username }}</span> on 
                                    <span class="date-badge">{{ history.changed_at }}</span>
                                </li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <p class="no-data-message">No status history for this deal.</p>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="alert alert-error">No deal found.</div>
            {% endif %}

            <!-- Associated files section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Associated Files</h3>
                </div>
                <div class="card-body">
                    {% if files %}
                        <ul id="fileList" class="file-list">
                        {% for file in files %}
                            <li class="file-item">
                                <span class="file-name">{{ file.file_name }}</span>
                                <div class="file-actions">
                                    <a href="{{ file.dropbox_link }}" target="_blank" class="btn btn-sm btn-primary">View on Dropbox</a>
                                    <a href="#" onclick="deleteFile({{ file.id }}, event);" class="btn btn-sm btn-danger">Delete</a>
                                </div>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <p class="no-data-message">No files associated with this deal.</p>
                    {% endif %}
                </div>
            </div>

            <!-- File upload form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Upload New File</h3>
                </div>
                <div class="card-body">
                    <div id="fileSuccessMessage" style="display: none;" class="alert alert-success mb-3">File uploaded successfully!</div>
                    <form id="fileForm" action="{{ url_for('files', deal_id=deal.id) }}" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="form-group">
                            <label for="file_name" class="form-label">File Name</label>
                            <input type="text" id="file_name" name="file_name" class="form-control" required>
                            <span class="error-message" id="file_name_error"></span>
                        </div>
                        <div class="form-group">
                            <label for="dropbox_link" class="form-label">Dropbox Link</label>
                            <input type="text" id="dropbox_link" name="dropbox_link" class="form-control" required>
                            <span class="error-message" id="dropbox_link_error"></span>
                        </div>
                        <button type="submit" class="btn btn-primary">Upload File</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for file and deal management -->
    <script>
        // Function to show the edit form
        function showEditForm() {
            document.getElementById('editForm').style.display = 'block';
        }

        // Function to hide the edit form
        function hideEditForm() {
            document.getElementById('editForm').style.display = 'none';
        }

        // Function to delete a deal
        function deleteDeal(dealId) {
            if (confirm('Are you sure you want to delete this deal and all its files?')) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                if (!csrfToken) {
                    console.error('CSRF token not found');
                    alert('CSRF token not found');
                    return;
                }
                fetch(`/api/deals/${dealId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    console.log('Delete deal response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to delete deal');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Delete deal data:', data);
                    alert(data.message);
                    window.location.href = '/';  // Redirect to home page
                })
                .catch(error => {
                    console.error('Error deleting deal:', error);
                    alert('Error deleting deal: ' + error.message);
                });
            }
        }

        // Function to delete a file
        function deleteFile(fileId, event) {
            event.preventDefault();
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            if (!csrfToken) {
                console.error('CSRF token not found');
                alert('CSRF token not found');
                return;
            }
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`/api/files/${fileId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    console.log('Delete file response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to delete file');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Delete file data:', data);
                    alert(data.message);
                    fetchFiles(); // Refresh the file list
                })
                .catch(error => {
                    console.error('Error deleting file:', error);
                    alert('Error deleting file: ' + error.message);
                });
            }
        }

        // Function to fetch and update the file list
        function fetchFiles() {
            const dealId = {{ deal.id }};
            fetch(`/api/files/${dealId}`, {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                console.log('Fetch files response status:', response.status);
                if (!response.ok) {
                    throw new Error(`Failed to fetch files: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Files data received:', data);
                const fileList = document.getElementById('fileList');
                if (fileList) {
                    if (data.length > 0) {
                        fileList.innerHTML = '';
                        data.forEach(file => {
                            const li = document.createElement('li');
                            li.className = 'file-item';
                            li.innerHTML = `
                                <span class="file-name">${file.file_name}</span>
                                <div class="file-actions">
                                    <a href="${file.dropbox_link}" target="_blank" class="btn btn-sm btn-primary">View on Dropbox</a>
                                    <a href="#" onclick="deleteFile(${file.id}, event);" class="btn btn-sm btn-danger">Delete</a>
                                </div>
                            `;
                            fileList.appendChild(li);
                        });
                    } else {
                        fileList.innerHTML = '<p class="no-data-message">No files associated with this deal.</p>';
                    }
                }
            })
            .catch(error => console.error('Error fetching files:', error));
        }

        // Event listeners for form handling
        document.addEventListener('DOMContentLoaded', function() {
            const fileForm = document.getElementById('fileForm');
            const fileInputs = fileForm.querySelectorAll('input[required]');
            const fileSuccessMessage = document.getElementById('fileSuccessMessage');
            const editDealForm = document.getElementById('editDealForm');
            const editInputs = editDealForm ? editDealForm.querySelectorAll('input[required]') : [];
            const editSuccessMessage = document.getElementById('editSuccessMessage');

            // Validate and handle file upload form
            fileInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.tagName === 'INPUT' && this.hasAttribute('required')) validateField(this, 'file');
                });
                input.addEventListener('input', function() {
                    if (this.value.trim() !== '' && this.tagName === 'INPUT' && this.hasAttribute('required')) {
                        document.getElementById(`${this.id}_error`).textContent = '';
                    }
                });
            });

            fileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                let isValid = true;
                fileInputs.forEach(input => {
                    if (!validateField(input, 'file')) isValid = false;
                });
                if (isValid) {
                    const formData = new FormData(fileForm);
                    fetch(fileForm.action, {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    })
                    .then(response => {
                        console.log('File submission response:', response.status);
                        if (!response.ok) {
                            return response.json().then(error => { throw new Error(error.error || 'Bad request'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('File submission data:', data);
                        if (data.message) {
                            fileSuccessMessage.textContent = data.message;
                            fileSuccessMessage.style.display = 'block';
                            fileForm.reset();
                            setTimeout(() => fileSuccessMessage.style.display = 'none', 3000);
                            fetchFiles(); // Refresh file list
                        } else if (data.error) {
                            fileSuccessMessage.textContent = data.error;
                            fileSuccessMessage.style.color = 'var(--color-error)';
                            fileSuccessMessage.style.display = 'block';
                            setTimeout(() => fileSuccessMessage.style.display = 'none', 3000);
                        }
                    })
                    .catch(error => {
                        console.error('File submission error:', error);
                        fileSuccessMessage.textContent = error.message || 'An error occurred';
                        fileSuccessMessage.style.color = 'var(--color-error)';
                        fileSuccessMessage.style.display = 'block';
                        setTimeout(() => fileSuccessMessage.style.display = 'none', 3000);
                    });
                }
            });

            // Validate and handle deal edit form
            if (editDealForm) {
                editInputs.forEach(input => {
                    input.addEventListener('blur', function() {
                        if (this.tagName === 'INPUT' && this.hasAttribute('required')) validateField(this, 'deal');
                    });
                    input.addEventListener('input', function() {
                        if (this.value.trim() !== '' && this.tagName === 'INPUT' && this.hasAttribute('required')) {
                            document.getElementById(`${this.id}_error`).textContent = '';
                        }
                    });
                });

                editDealForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    let isValid = true;
                    editInputs.forEach(input => {
                        if (!validateField(input, 'deal')) isValid = false;
                    });
                    if (isValid) {
                        const formData = new FormData(editDealForm);
                        fetch(editDealForm.action, {
                            method: 'PUT',
                            body: formData,
                            credentials: 'include'
                        })
                        .then(response => {
                            console.log('Deal update response status:', response.status);
                            if (!response.ok) {
                                return response.json().then(error => { throw new Error(error.error || 'Bad request'); });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Deal update data:', data);
                            if (data.message) {
                                editSuccessMessage.textContent = data.message;
                                editSuccessMessage.style.display = 'block';
                                hideEditForm();
                                setTimeout(() => editSuccessMessage.style.display = 'none', 3000);
                                // Optionally, refresh the page or update UI to reflect changes
                                window.location.reload();  // Reload to show updated deal details and status history
                            } else if (data.error) {
                                editSuccessMessage.textContent = data.error;
                                editSuccessMessage.style.color = 'var(--color-error)';
                                editSuccessMessage.style.display = 'block';
                                setTimeout(() => editSuccessMessage.style.display = 'none', 3000);
                            }
                        })
                        .catch(error => {
                            console.error('Error updating deal:', error);
                            editSuccessMessage.textContent = error.message || 'An error occurred';
                            editSuccessMessage.style.color = 'var(--color-error)';
                            editSuccessMessage.style.display = 'block';
                            setTimeout(() => editSuccessMessage.style.display = 'none', 3000);
                        });
                    }
                });
            }

            function validateField(field, formType) {
                if (!field) {
                    console.error('Field is undefined');
                    return true;
                }
                if (field.tagName === 'INPUT' && field.hasAttribute('required')) {
                    const errorElement = document.getElementById(`${field.id}_error`);
                    if (!errorElement) {
                        console.error(`Error element not found for field: ${field.id}`);
                        return true;
                    }
                    if (!field.value || !field.value.trim()) {
                        errorElement.textContent = 'Field required';
                        errorElement.style.color = 'var(--color-error)';
                        return false;
                    }
                    errorElement.textContent = '';
                    return true;
                }
                return true;
            }

            // Fetch files when the page loads
            fetchFiles();
        });
    </script>
</body>
</html>